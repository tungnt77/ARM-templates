{
   "$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "appName":{
         "type":"string",
         "defaultValue":"QRtoSentinel",
         "metadata":{
            "description":"The name of the function app that you will create to import QRadar offenses"
         }
      },
      "storageAccountType":{
         "type":"string",
         "defaultValue":"Standard_LRS",
         "allowedValues":[
            "Standard_LRS",
            "Standard_GRS",
            "Standard_RAGRS"
         ],
         "metadata":{
            "description":"Storage Account type"
         }
      },
      "QRadarManagementIP":{
         "type":"string",
         "metadata":{
            "description":"Give the management / console ip for QRadar"
         }
      },
      "QRadarToken":{
         "type":"string",
         "metadata":{
            "description":"Input your authentication token for QRadar"
         }
      },
      "ServicePrincipalID":{
         "type":"string",
         "metadata":{
            "description":"Azure service principal id"
         }
      },
      "ServicePrincipalSecret":{
         "type":"string",
         "metadata":{
            "description":"Azure service principal secret"
         }
      },
      "TenantID":{
         "type":"string",
         "metadata":{
            "description":"Tenant ID"
         }
      },
      "WorkspaceID":{
         "type":"string",
         "metadata":{
            "description":"Provide the workspace ID for your Azure Sentinel solution"
         }
      },
      "WorkspaceKey":{
         "type":"string",
         "metadata":{
            "description":"Provide the primary key to this Log Analytics workspace"
         }
      }
   },
   "variables":{
      "functionAppName":"[concat(toLower(parameters('appName')), uniqueString(resourceGroup().id))]",
      "hostingPlanName":"[parameters('appName')]",
      "storageAccountName":"[concat(uniquestring(resourceGroup().id), 'azfunctions')]"
   },
   "resources":[
      {
         "type":"Microsoft.Web/serverfarms",
         "apiVersion":"2020-06-01",
         "name":"[variables('hostingPlanName')]",
         "location":"[resourceGroup().location]",
         "kind":"Linux",
         "sku":{
            "name":"S1"
         },
         "properties":{
            "reserved":true
         }
      },
      {
         "type":"Microsoft.Insights/components",
         "apiVersion":"2015-05-01",
         "name":"[variables('functionAppName')]",
         "location":"[resourceGroup().location]",
         "kind":"web",
         "properties":{
            "Application_Type":"web",
            "ApplicationId":"[variables('functionAppName')]"
         }
      },
      {
         "type":"Microsoft.Web/sites",
         "apiVersion":"2019-08-01",
         "name":"[variables('functionAppName')]",
         "kind":"functionapp,linux",
         "identity":{
            "type":"SystemAssigned"
         },
         "location":"[resourceGroup().location]",
         "dependsOn":[
            "[resourceId('Microsoft.Web/serverfarms/', variables('hostingPlanName'))]",
            "[resourceId('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]"
         ],
         "properties":{
            "name":"[variables('functionAppName')]",
            "serverFarmId":"[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
            "httpsOnly":true,
            "clientAffinityEnabled":true,
            "alwaysOn":true,
            "reserved":true
         },
         "resources":[
            {
               "apiVersion":"2018-11-01",
               "type":"config",
               "name":"appsettings",
               "dependsOn":[
                  "[concat('Microsoft.Web/sites/', variables('functionAppName'))]"
               ],
               "properties":{
                  "FUNCTIONS_EXTENSION_VERSION":"~3",
                  "FUNCTIONS_WORKER_RUNTIME":"python",
                  "APPINSIGHTS_INSTRUMENTATIONKEY":"[reference(resourceId('Microsoft.insights/components', variables('functionAppName')), '2015-05-01').InstrumentationKey]",
                  "APPLICATIONINSIGHTS_CONNECTION_STRING":"[reference(resourceId('microsoft.insights/components', variables('functionAppName')), '2015-05-01').ConnectionString]",
                  "AzureWebJobsStorage":"[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';EndpointSuffix=', environment().suffixes.storage, ';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2019-06-01').keys[0].value)]",
                  "consoleIP":"[parameters('QRadarManagementIP')]",
                  "token":"[parameters('QRadarToken')]",
                  "tenant":"[parameters('TenantID')]",
                  "sp_id":"[parameters('ServicePrincipalID')]",
                  "sp_secret":"[parameters('ServicePrincipalSecret')]",
                  "customerID":"[parameters('WorkspaceID')]",
                  "sharedKey":"[parameters('WorkspaceKey')]",
                  "SCM_DO_BUILD_DURING_DEPLOYMENT":true,
                  "WEBSITE_RUN_FROM_PACKAGE":"https://github.com/tungnt77/ARM-templates/raw/main/TimeTrigger.zip"
               }
            }
         ]
      },
      {
         "type":"Microsoft.Storage/storageAccounts",
         "apiVersion":"2019-06-01",
         "name":"[variables('storageAccountName')]",
         "location":"[resourceGroup().location]",
         "sku":{
            "name":"[parameters('storageAccountType')]"
         }
      }
   ]
}
